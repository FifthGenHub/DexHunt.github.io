<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>DexHunt: Cowboy Reflex Showdown</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="192x192" href="/android-chrome-192x192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="/android-chrome-512x512.png">
  <link rel="manifest" href="/site.webmanifest">
  <script src="https://cdn.jsdelivr.net/npm/@solana/web3.js@1.95.3/lib/index.iife.min.js"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      font-family: 'Courier New', Courier, monospace;
      background: #000;
      color: #ffc34d;
      text-align: center;
    }
    .game-container {
      width: 100vw;
      height: 100vh;
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
    }
    h1 {
      font-size: clamp(1.5rem, 5vw, 2.2rem);
      background: rgba(0, 0, 0, 0.9);
      padding: 1rem;
      margin: 0;
      width: 100%;
      z-index: 2;
      text-shadow: 2px 2px #ff9900;
    }
    .button-row {
      margin-top: 1rem;
      background: rgba(0, 0, 0, 0.8);
      padding: 1rem;
      width: 100%;
      z-index: 2;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 15px;
    }
    .wallet-btn, .start-btn, .links-leaderboard-btn, .settings-btn {
      background-color: #ff9900;
      border: none;
      border-radius: 8px;
      padding: 14px 24px;
      font-size: clamp(0.9rem, 2.5vw, 1.1rem);
      cursor: pointer;
      color: #1a1a1a;
      font-weight: bold;
    }
    .wallet-btn:hover, .start-btn:hover, .links-leaderboard-btn:hover, .settings-btn:hover {
      background-color: #cc7a00;
    }
    select {
      padding: 14px;
      font-size: clamp(0.9rem, 2.5vw, 1.1rem);
      border-radius: 8px;
      background: #fff;
      color: #1a1a1a;
    }
    .log {
      margin-top: 20px;
      font-size: clamp(0.9rem, 2.5vw, 1.1rem);
      color: #fff;
      background: rgba(0, 0, 0, 0.6);
      padding: 12px 24px;
      border-radius: 10px;
      width: 80%;
      max-width: 600px;
      z-index: 2;
    }
    .countdown {
      font-size: clamp(2rem, 5vw, 4rem);
      font-weight: bold;
      color: #ffc34d;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 20;
      background: rgba(0, 0, 0, 0.7);
      padding: 1rem 2rem;
      border-radius: 12px;
    }
    .bang {
      position: absolute;
      display: none;
      z-index: 10;
      cursor: pointer;
      animation: pulse 0.3s infinite;
      width: 200px;
      height: 200px;
      object-fit: contain;
    }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    .quick-draw {
      font-size: clamp(1.5rem, 3vw, 2rem);
      color: #ffcc00;
      position: absolute;
      top: 30%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 15;
      animation: flash 0.5s 3;
    }
    @keyframes flash {
      0%, 100% { opacity: 1; }
      50% { opacity: 0; }
    }
    .emoji {
      font-size: clamp(1.5rem, 3vw, 2rem);
    }
    .duel-area {
      flex-grow: 1;
      width: 100%;
      position: relative;
      border-top: 5px solid #ff9900;
      border-bottom: 5px solid #ff9900;
      overflow: hidden;
      height: calc(100vh - 150px);
    }
    #gameCanvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 1;
      pointer-events: none;
    }
    .leaderboard-popup, .tutorial-popup, .double-or-nothing-popup, .settings-popup {
      display: none;
      position: absolute;
      top: 20%;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.85);
      padding: 20px;
      border-radius: 12px;
      color: #ffc34d;
      font-size: clamp(0.9rem, 2.5vw, 1.1rem);
      z-index: 1000;
      max-width: 90%;
      text-align: center;
    }
    .share-buttons {
      margin-top: 15px;
      display: flex;
      justify-content: center;
      gap: 10px;
    }
    .share-btn, .sound-toggle-btn, .reset-btn {
      background-color: #ff9900;
      border: none;
      border-radius: 8px;
      padding: 12px 18px;
      font-size: clamp(0.8rem, 2vw, 1rem);
      cursor: pointer;
      color: #1a1a1a;
      font-weight: bold;
    }
    .share-btn:hover, .sound-toggle-btn:hover, .reset-btn:hover {
      background-color: #cc7a00;
    }
    #loadingScreen {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #000;
      color: #ffc34d;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: clamp(1.5rem, 3vw, 2rem);
      z-index: 1000;
      flex-direction: column;
    }
    @media (max-width: 600px) {
      .bang {
        width: 150px;
        height: 150px;
      }
      .button-row {
        gap: 10px;
      }
      .wallet-btn, .start-btn, .links-leaderboard-btn, .settings-btn, select {
        padding: 10px 18px;
        font-size: clamp(0.8rem, 2vw, 1rem);
      }
    }
  </style>
</head>
<body>
  <div id="loadingScreen">Loading...</div>

  <audio id="gunshot" src="assets/sounds/revovler-sound-328431.mp3" preload="auto"></audio>
  <audio id="toosoon" src="assets/sounds/clickmouse-266516.mp3" preload="auto"></audio>
  <audio id="winSound" src="assets/sounds/multi-coin-payout-14-213732.mp3" preload="auto"></audio>
  <audio id="loseSound" src="assets/sounds/8-bit-video-game-lose-sound-version-1-145828.mp3" preload="auto"></audio>
  <audio id="resetSound" src="assets/sounds/clean-revolver-reload-6889.mp3" preload="auto"></audio>
  <audio id="startSound" src="assets/sounds/coin-donation-1-180437.mp3" preload="auto"></audio>
  <audio id="walletSound" src="assets/sounds/yeehaw-13229.mp3" preload="auto"></audio>
  <audio id="coyoteHowl" src="assets/sounds/coyote-howl.mp3" preload="auto"></audio>
  <audio id="drawSound" src="assets/sounds/draw-sound.mp3" preload="auto"></audio>
  <audio id="backgroundMusic" loop>
    <source src="assets/sounds/background_music.mp3" type="audio/mpeg">
  </audio>
  <audio id="tumbleweedRoll" src="assets/sounds/tumbleweed_roll.mp3" preload="auto"></audio>

  <div class="game-container" id="game">
    <h1><span class="emoji">ðŸ¤ </span> DexHunt: Cowboy Reflex Showdown</h1>
    <div class="button-row" id="buttonRow">
      <button class="wallet-btn" onclick="connectWallet()">Connect Wallet</button>
      <select id="rewardType" style="padding: 14px; margin: 0 8px; border-radius: 8px;">
        <option value="sol">Win SOL</option>
        <option value="dex">Win $DHUNT</option>
      </select>
      <select id="betAmount" onchange="setBetAmount(this.value)" style="padding: 14px; margin: 0 8px; border-radius: 8px;">
        <option value="0.0007">Bet 0.0007 SOL (~$0.10 USD)</option>
        <option value="0.00175">Bet 0.00175 SOL (~$0.25 USD)</option>
        <option value="0.0035" selected>Bet 0.0035 SOL (~$0.50 USD)</option>
        <option value="0.01">Bet 0.01 SOL (~$1.50 USD)</option>
      </select>
      <button class="start-btn" onclick="startDuel()">Start Duel</button>
      <button class="links-leaderboard-btn" onclick="toggleLinksLeaderboard()">Leaderboard & Stats</button>
      <button class="settings-btn" onclick="toggleSettings()">Settings</button>
    </div>
    <div class="log" id="log">Think youâ€™re quick enough, cowboy? Beat Sawn-Off Slim in under 0.5 seconds!</div>
    <div class="duel-area" id="duel-area">
      <canvas id="gameCanvas"></canvas>
      <img class="bang" id="bang" src="assets/pow_explosion.png" style="display:none;" onclick="shoot();" />
      <div id="countdown" class="countdown" style="display:none;"></div>
      <div id="quickDraw" class="quick-draw" style="display:none;">Quick Draw!</div>
    </div>
    <div class="leaderboard-popup" id="leaderboardPopup"></div>
    <div class="tutorial-popup" id="tutorialPopup">
      <h3>Welcome to DexHunt!</h3>
      <p>1. Connect your wallet to start.</p>
      <p>2. Choose your bet (0.0007â€“0.01 SOL).</p>
      <p>3. Click "Start Duel" and wait for "SHOOT NOW!"</p>
      <p>4. Click "BANG!" fast to win:</p>
      <p>- Under 500ms: 1.5x SOL or 1000x $DHUNT + bonus chance!</p>
      <p>- Under 250ms: Earn a "Lightning Draw" NFT!</p>
      <p>- 500â€“600ms: 0.000875 SOL.</p>
      <button onclick="closeTutorial()">Got It!</button>
    </div>
    <div class="double-or-nothing-popup" id="doubleOrNothingPopup">
      <h3>Double or Nothing!</h3>
      <p>5 losses in a row! Risk 0.015 SOL to win 0.03 SOL?</p>
      <button class="share-btn" onclick="startDoubleOrNothing()">Yes</button>
      <button class="share-btn" onclick="declineDoubleOrNothing()">No</button>
    </div>
    <div class="settings-popup" id="settingsPopup">
      <h3>Settings</h3>
      <button class="sound-toggle-btn" onclick="toggleSound()">Mute Sound</button>
      <button class="reset-btn" onclick="resetDuel()">Reset Duel</button>
      <button class="share-btn" onclick="toggleSettings()">Close</button>
    </div>
  </div>

  <script>
    let duelTimeout, reactionTimeout, countdownInterval;
    let canShoot = false;
    let walletConnected = false;
    let bangShownAt = 0;
    let totalDuels = parseInt(localStorage.getItem('totalDuels')) || 0;
    let totalDhuntEarned = parseInt(localStorage.getItem('totalDhuntEarned')) || 0;
    let bestDraw = parseInt(localStorage.getItem('bestDraw')) || null;
    let coyoteHowlTriggered = false;
    let consecutiveLosses = 0;
    let playStreak = 0;
    let reactionWindow = 750;
    let betAmount = 0.0035;
    let loginStreak = parseInt(localStorage.getItem('loginStreak')) || 0;
    let isMuted = localStorage.getItem('isMuted') === 'true';
    let userPublicKey = null;
    let isDoubleOrNothing = false;
    let reactionTimes = JSON.parse(localStorage.getItem('reactionTimes')) || [];
    let reactionStats = JSON.parse(localStorage.getItem('reactionStats')) || { fullWins: 0, smallerPrizes: 0, losses: 0 };
    let solStats = JSON.parse(localStorage.getItem('solStats')) || { totalWagered: 0, netWon: 0 };
    let dailyChallenge = JSON.parse(localStorage.getItem('dailyChallenge')) || { winsToday: 0, lastReset: new Date().toDateString(), rewardClaimed: false };
    let weeklyChallenge = JSON.parse(localStorage.getItem('weeklyChallenge')) || { duelsPlayed: 0, weekStart: getWeekNumber(), rewardClaimed: false };
    let playerLevel = JSON.parse(localStorage.getItem('playerLevel')) || { level: 1, duelsForNextLevel: 10 };
    let globalLeaderboard = JSON.parse(localStorage.getItem('globalLeaderboard')) || [
      { name: 'Cowboy#1', time: 250 }, { name: 'Cowboy#2', time: 260 }, { name: 'Cowboy#3', time: 270 },
      { name: 'Cowboy#4', time: 280 }, { name: 'Cowboy#5', time: 290 }
    ];

    const audioElements = [
      document.getElementById('gunshot'),
      document.getElementById('toosoon'),
      document.getElementById('winSound'),
      document.getElementById('loseSound'),
      document.getElementById('resetSound'),
      document.getElementById('startSound'),
      document.getElementById('walletSound'),
      document.getElementById('coyoteHowl'),
      document.getElementById('drawSound'),
      document.getElementById('backgroundMusic'),
      document.getElementById('tumbleweedRoll')
    ];

    audioElements.forEach(audio => audio.muted = isMuted);
    document.querySelector('.sound-toggle-btn').textContent = isMuted ? 'Unmute Sound' : 'Mute Sound';

    function getWeekNumber() {
      const now = new Date();
      const start = new Date(now.getFullYear(), 0, 1);
      const diff = now - start;
      const oneWeek = 1000 * 60 * 60 * 24 * 7;
      return Math.floor(diff / oneWeek) + 1;
    }

    async function connectWallet() {
      const log = document.getElementById('log');
      log.textContent = 'Connecting wallet...';
      try {
        const { solana } = window;
        if (!solana || !solana.isPhantom) {
          log.textContent = 'Please install Phantom Wallet!';
          return;
        }
        const provider = solana;
        const response = await provider.connect();
        userPublicKey = response.publicKey.toString();
        walletConnected = true;
        const connection = new window.solanaWeb3.Connection('https://api.devnet.solana.com', 'confirmed');
        const balance = await connection.getBalance(response.publicKey);
        const solBalance = balance / 1000000000;
        audioElements[6].play();
        log.textContent = `Wallet Connected: ${userPublicKey.slice(0, 8)}... | Balance: ${solBalance.toFixed(4)} SOL`;
      } catch (error) {
        console.error('Wallet connection failed:', error);
        log.textContent = 'Wallet connection failed. Please try again.';
      }
    }

    function setBetAmount(amount) {
      betAmount = parseFloat(amount);
      document.getElementById('log').textContent = `Bet set to ${betAmount} SOL!`;
    }

    function dailyLoginReward() {
      const today = new Date().toDateString();
      const lastLogin = localStorage.getItem('lastLogin');
      if (lastLogin !== today) {
        loginStreak++;
        let reward = loginStreak >= 5 ? 20 : 10;
        let extraReward = '';
        if (!localStorage.getItem('xFollowReward')) {
          extraReward = ' + 50 $DHUNT for following @DexHuntGame on X!';
          localStorage.setItem('xFollowReward', 'true');
          reward += 50;
        }
        totalDhuntEarned += reward;
        localStorage.setItem('totalDhuntEarned', totalDhuntEarned);
        localStorage.setItem('lastLogin', today);
        localStorage.setItem('loginStreak', loginStreak);
        document.getElementById('log').textContent = `Daily Login: Earned ${reward} $DHUNT! Streak: ${loginStreak} days${extraReward}`;
        if (loginStreak >= 5) loginStreak = 0;
      } else {
        document.getElementById('log').textContent = 'Already claimed todayâ€™s login reward!';
      }
    }

    function toggleSettings() {
      const popup = document.getElementById('settingsPopup');
      popup.style.display = popup.style.display === 'block' ? 'none' : 'block';
    }

    function startDuel() {
      audioElements[5].play();
      try {
        audioElements[9].play().catch(err => console.error("Failed to play background music:", err));
      } catch (err) {
        console.error("Error playing background music:", err);
      }
      const log = document.getElementById('log');
      const bang = document.getElementById('bang');
      if (!walletConnected) {
        log.textContent = 'Please connect wallet first!';
        return;
      }
      bang.style.display = 'none';
      canShoot = false;
      coyoteHowlTriggered = false;
      const currentBet = isDoubleOrNothing ? 0.015 : betAmount;
      log.textContent = `Get ready... Sawn-Off Slim is watchinâ€™... Betting ${currentBet.toFixed(4)} SOL!`;
      const delay = Math.random() * 9000 + 1000;
      const additionalDelay = Math.random() * 2000;
      duelTimeout = setTimeout(() => {
        showBang();
      }, delay + additionalDelay);
      if (Math.random() < 0.1) {
        setTimeout(() => {
          if (canShoot) return;
          audioElements[7].play();
          log.textContent = 'Sly the Coyote howls! Wait a bit longer...';
          coyoteHowlTriggered = true;
        }, delay + additionalDelay - 1000);
      }
    }
  </script>
</body>
</html>
<script>
  function showBang() {
    const bang = document.getElementById('bang');
    const duelArea = document.getElementById('duel-area');
    const log = document.getElementById('log');
    const bangWidth = window.innerWidth <= 600 ? 150 : 200;
    const bangHeight = bangWidth;
    const padding = 50;
    const maxX = duelArea.clientWidth - bangWidth - padding;
    const maxY = duelArea.clientHeight - bangHeight - padding;
    const x = Math.random() * maxX + padding / 2;
    const y = Math.random() * maxY + padding / 2;
    bang.style.left = `${x}px`;
    bang.style.top = `${y}px`;
    bang.style.display = 'block';
    canShoot = true;
    bangShownAt = performance.now();
    log.textContent = 'SHOOT NOW! ðŸ¤ ';
    audioElements[8].play();
    reactionTimeout = setTimeout(() => {
      if (canShoot) {
        canShoot = false;
        bang.style.display = 'none';
        log.textContent = '<span style="color: red;">Too slow, cowboy! Sawn-Off Slim wins!</span>';
        reactionTimes.push(Math.round(performance.now() - bangShownAt));
        reactionStats.losses++;
        solStats.totalWagered += isDoubleOrNothing ? 0.015 : betAmount;
        localStorage.setItem('reactionTimes', JSON.stringify(reactionTimes));
        localStorage.setItem('reactionStats', JSON.stringify(reactionStats));
        localStorage.setItem('solStats', JSON.stringify(solStats));
        audioElements[3].play();
        consecutiveLosses++;
        playStreak++;
        checkStreak();
        checkDoubleOrNothing();
        if (isDoubleOrNothing) {
          log.textContent += ' Double or Nothing failed! Lost 0.015 SOL!';
          isDoubleOrNothing = false;
          consecutiveLosses = 0;
        }
      }
    }, coyoteHowlTriggered ? 1000 : 750);
  }

  async function shoot() {
    console.log("Shoot function triggered");
    const bang = document.getElementById('bang');
    const log = document.getElementById('log');
    const quickDraw = document.getElementById('quickDraw');
    const rewardType = document.getElementById('rewardType').value;
    const now = performance.now();
    const reactionTime = Math.round(now - bangShownAt);
    const avgReactionTime = reactionTimes.length > 0 ? reactionTimes.reduce((a, b) => a + b, 0) / reactionTimes.length : 600;

    if (canShoot) {
      clearTimeout(reactionTimeout);
      bang.style.display = 'none';
      canShoot = false;
      playStreak++;
      reactionTimes.push(reactionTime);
      audioElements[0].play();

      if (reactionTime < 500) {
        consecutiveLosses = 0;
        reactionWindow = Math.max(600, reactionWindow - 50);
        reactionStats.fullWins++;
        let bonus = Math.random() < 0.15 ? ' + Bonus 0.001 SOL!' : '';
        let payout, message;
        if (isDoubleOrNothing) {
          payout = 0.015 * 2;
          message = `<span style="color: green;">Double or Nothing Success! Draw time: ${reactionTime}ms. Won ${payout.toFixed(4)} SOL! Keep it under 500ms!</span>`;
          isDoubleOrNothing = false;
        } else if (rewardType === 'sol') {
          payout = betAmount * 1.5 * (playerLevel.level >= 3 ? 2 : 1);
          message = `<span style="color: green;">Blazing fast, cowboy! Draw time: ${reactionTime}ms. Won ${payout.toFixed(4)} SOL!${bonus} Keep it under 500ms!</span>`;
          solStats.netWon += payout - betAmount;
        } else {
          bonus = Math.random() < 0.15 ? ' + Bonus 50 $DHUNT!' : '';
          payout = betAmount * 1000;
          totalDhuntEarned += payout + (bonus ? 50 : 0);
          message = `<span style="color: green;">Blazing fast, cowboy! Draw time: ${reactionTime}ms. Won ${payout} $DHUNT!${bonus} Keep it under 500ms!</span>`;
        }
        log.textContent = message;
        quickDraw.style.display = 'block';
        setTimeout(() => quickDraw.style.display = 'none', 1500);
        audioElements[2].play();
        if (reactionTime < 250) {
          log.textContent += ' Earned "Lightning Draw" NFT!';
        }
        dailyChallenge.winsToday += dailyChallenge.lastReset === new Date().toDateString() ? 1 : (dailyChallenge.winsToday = 1, 1);
        dailyChallenge.lastReset = new Date().toDateString();
        updateGlobalLeaderboard(reactionTime);
      } else if (reactionTime < 600) {
        reactionStats.smallerPrizes++;
        log.textContent = `<span style="color: yellow;">So close! Draw time: ${reactionTime}ms. Won 0.000875 SOL! Just ${500 - reactionTime}ms from a full win!</span>`;
        quickDraw.style.display = 'block';
        setTimeout(() => quickDraw.style.display = 'none', 1500);
        consecutiveLosses++;
        reactionWindow = Math.min(750, reactionWindow + 50);
        audioElements[2].play();
        solStats.netWon += 0.000875 - betAmount;
        if (isDoubleOrNothing) {
          log.textContent += ' Double or Nothing failed! Lost 0.015 SOL!';
          isDoubleOrNothing = false;
          consecutiveLosses = 0;
        }
      } else {
        reactionStats.losses++;
        log.textContent = `<span style="color: red;">Not quick enough! Draw time: ${reactionTime}ms. Aim for under 600ms! Youâ€™re ${reactionTime - 600}ms too slow.</span>`;
        consecutiveLosses++;
        reactionWindow = Math.min(750, reactionWindow + 50);
        audioElements[3].play();
        if (isDoubleOrNothing) {
          log.textContent += ' Double or Nothing failed! Lost 0.015 SOL!';
          isDoubleOrNothing = false;
          consecutiveLosses = 0;
        }
      }
      solStats.totalWagered += isDoubleOrNothing ? 0.015 : betAmount;
      localStorage.setItem('reactionTimes', JSON.stringify(reactionTimes));
      localStorage.setItem('reactionStats', JSON.stringify(reactionStats));
      localStorage.setItem('solStats', JSON.stringify(solStats));
      localStorage.setItem('totalDhuntEarned', totalDhuntEarned);
      localStorage.setItem('dailyChallenge', JSON.stringify(dailyChallenge));
      if (bestDraw === null || reactionTime < bestDraw) {
        bestDraw = reactionTime;
        localStorage.setItem('bestDraw', bestDraw);
      }
      totalDuels++;
      weeklyChallenge.duelsPlayed++;
      playerLevel.duelsForNextLevel--;
      if (playerLevel.duelsForNextLevel <= 0) {
        playerLevel.level++;
        playerLevel.duelsForNextLevel = 10 + playerLevel.level * 2;
        log.textContent += ` Leveled up to ${playerLevel.level}! ${playerLevel.level >= 3 ? 'Jackpot Duel Unlocked!' : ''}`;
        localStorage.setItem('playerLevel', JSON.stringify(playerLevel));
      }
      localStorage.setItem('totalDuels', totalDuels);
      localStorage.setItem('weeklyChallenge', JSON.stringify(weeklyChallenge));
      checkStreak();
      checkDoubleOrNothing();
    } else {
      clearTimeout(reactionTimeout);
      bang.style.display = 'none';
      log.textContent = '<span style="color: red;">YEE-HAW! Too Soon, Cowboy! Sawn-Off Slim smirks...</span>';
      reactionTimes.push(0);
      reactionStats.losses++;
      solStats.totalWagered += isDoubleOrNothing ? 0.015 : betAmount;
      localStorage.setItem('reactionTimes', JSON.stringify(reactionTimes));
      localStorage.setItem('reactionStats', JSON.stringify(reactionStats));
      localStorage.setItem('solStats', JSON.stringify(solStats));
      audioElements[1].play();
      consecutiveLosses++;
      playStreak++;
      checkStreak();
      checkDoubleOrNothing();
      if (isDoubleOrNothing) {
        log.textContent += ' Double or Nothing failed! Lost 0.015 SOL!';
        isDoubleOrNothing = false;
        consecutiveLosses = 0;
      }
    }
  }

  function updateGlobalLeaderboard(reactionTime) {
    if (reactionTime >= 500) return;
    const playerName = userPublicKey ? `Cowboy#${userPublicKey.slice(0, 4)}` : `Cowboy#${Math.random().toString(36).substr(2, 4)}`;
    globalLeaderboard.push({ name: playerName, time: reactionTime });
    globalLeaderboard.sort((a, b) => a.time - b.time);
    globalLeaderboard = globalLeaderboard.slice(0, 5);
    localStorage.setItem('globalLeaderboard', JSON.stringify(globalLeaderboard));
  }

  function exportReactionData() {
    let csvContent = "Duel,ReactionTime(ms),Outcome\n";
    reactionTimes.forEach((rt, index) => {
      let outcome = rt === 0 ? "Too Soon" : rt < 500 ? "Full Win" : rt < 600 ? "Smaller Prize" : "Loss";
      csvContent += `${index + 1},${rt},${outcome}\n`;
    });
    csvContent += `\nStats,Value\nFull Wins,${reactionStats.fullWins}\nSmaller Prizes,${reactionStats.smallerPrizes}\nLosses,${reactionStats.losses}\nAverage Reaction Time,${reactionTimes.length > 0 ? Math.round(reactionTimes.reduce((a, b) => a + b, 0) / reactionTimes.length) : 'N/A'}`;
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'DexHunt_ReactionData.csv';
    a.click();
    URL.revokeObjectURL(url);
    document.getElementById('log').textContent = 'Reaction data exported as CSV!';
  }

  function checkStreak() {
    const log = document.getElementById('log');
    if (playStreak % 3 === 0) {
      log.textContent += ' Nice streak! Earned 10 $DHUNT!';
      totalDhuntEarned += 10;
      localStorage.setItem('totalDhuntEarned', totalDhuntEarned);
    }
    if (playStreak % 5 === 0) {
      log.textContent += ' Hot streak! Earned 20 $DHUNT!';
      totalDhuntEarned += 20;
      localStorage.setItem('totalDhuntEarned', totalDhuntEarned);
    }
  }

  function checkDoubleOrNothing() {
    if (consecutiveLosses >= 5 && !isDoubleOrNothing) {
      const popup = document.getElementById('doubleOrNothingPopup');
      popup.style.display = 'block';
    }
  }

  function startDoubleOrNothing() {
    const popup = document.getElementById('doubleOrNothingPopup');
    popup.style.display = 'none';
    isDoubleOrNothing = true;
    consecutiveLosses = 0;
    startDuel();
  }

  function declineDoubleOrNothing() {
    const popup = document.getElementById('doubleOrNothingPopup');
    popup.style.display = 'none';
    consecutiveLosses = 0;
    document.getElementById('log').textContent = 'Double or Nothing declined. Keep practicing, cowboy!';
  }

  function resetDuel() {
    clearTimeout(duelTimeout);
    clearTimeout(reactionTimeout);
    document.getElementById('bang').style.display = 'none';
    document.getElementById('log').textContent = 'Think youâ€™re quick enough, cowboy? Beat Sawn-Off Slim in under 0.5 seconds!';
    canShoot = false;
    isDoubleOrNothing = false;
    audioElements[4].play();
    const countdownEl = document.getElementById('countdown');
    let timeLeft = 3;
    countdownEl.style.display = 'block';
    countdownEl.textContent = timeLeft;
    countdownInterval = setInterval(() => {
      timeLeft--;
      if (timeLeft > 0) {
        countdownEl.textContent = timeLeft;
      } else {
        clearInterval(countdownInterval);
        countdownEl.style.display = 'none';
        startDuel();
      }
    }, 1000);
  }

  function showTutorial() {
    if (!localStorage.getItem('tutorialSeen')) {
      document.getElementById('tutorialPopup').style.display = 'block';
      localStorage.setItem('tutorialSeen', 'true');
    }
  }

  function closeTutorial() {
    document.getElementById('tutorialPopup').style.display = 'none';
  }

  function toggleSound() {
    isMuted = !isMuted;
    audioElements.forEach(audio => audio.muted = isMuted);
    document.querySelector('.sound-toggle-btn').textContent = isMuted ? 'Unmute Sound' : 'Mute Sound';
    localStorage.setItem('isMuted', isMuted);
  }

  function updateLeaderboard() {
    const avgReactionTime = reactionTimes.length > 0 ? Math.round(reactionTimes.reduce((a, b) => a + b, 0) / reactionTimes.length) : 'N/A';
    const title = bestDraw < 250 ? 'Lightning Cowboy' : bestDraw < 500 ? 'Quick Draw' : 'Greenhorn';
    const recent10 = reactionTimes.slice(-10);
    const prev10 = reactionTimes.slice(-20, -10);
    const recentAvg = recent10.length > 0 ? recent10.reduce((a, b) => a + b, 0) / recent10.length : null;
    const prevAvg = prev10.length > 0 ? prev10.reduce((a, b) => a + b, 0) / prev10.length : null;
    const improvement = prevAvg && recentAvg ? Math.round(prevAvg - recentAvg) : null;
    const progressText = improvement ? (improvement > 0 ? `Progress: Improved by ${improvement}ms!` : `Progress: Reaction time up by ${-improvement}ms. Practice more!`) : 'Play more to track progress!';
    const challengeTarget = Math.max(avgReactionTime - 50, 350);
    const dailyChallengeText = dailyChallenge.winsToday >= 3 && dailyChallenge.lastReset === new Date().toDateString() ? 
      (dailyChallenge.rewardClaimed ? 'Daily Challenge Completed!' : `<button class="share-btn" onclick="claimDailyReward()">Claim 50 $DHUNT!</button>`) : 
      `Daily Challenge: Win ${3 - dailyChallenge.winsToday} duels under ${challengeTarget}ms today!`;
    const weeklyChallengeText = weeklyChallenge.duelsPlayed >= 10 && weeklyChallenge.weekStart === getWeekNumber() ? 
      (weeklyChallenge.rewardClaimed ? 'Weekly Challenge Completed!' : `<button class="share-btn" onclick="claimWeeklyReward()">Claim 100 $DHUNT!</button>`) : 
      `Weekly Challenge: Play ${10 - weeklyChallenge.duelsPlayed} more duels this week!`;

    let leaderboardHTML = '<h3>Global Leaderboard (Top 5)</h3>';
    globalLeaderboard.forEach((entry, index) => {
      leaderboardHTML += `<p>${index + 1}. ${entry.name}: ${entry.time}ms</p>`;
    });

    document.getElementById('leaderboardPopup').innerHTML = `
      <h3>Your Stats</h3>
      <p>Level: ${playerLevel.level} (Next level in ${playerLevel.duelsForNextLevel} duels)</p>
      <p>Fastest Draw: ${bestDraw || '--'}ms</p>
      <p>Average Reaction Time: ${avgReactionTime}ms</p>
      <p>Duels Played: ${totalDuels}</p>
      <p>Full Wins (<500ms): ${reactionStats.fullWins}</p>
      <p>Smaller Prizes (500â€“600ms): ${reactionStats.smallerPrizes}</p>
      <p>Losses (>600ms or too soon): ${reactionStats.losses}</p>
      <p>Win Rate: ${totalDuels > 0 ? Math.round((reactionStats.fullWins + reactionStats.smallerPrizes) / totalDuels * 100) : 0}%</p>
      <p>Total $DHUNT Earned: ${totalDhuntEarned}</p>
      <p>SOL Wagered: ${solStats.totalWagered.toFixed(4)} SOL</p>
      <p>Net SOL Won: ${solStats.netWon.toFixed(4)} SOL</p>
      <p>${progressText}</p>
      <p>Title: ${title}</p>
      <h3>Challenges</h3>
      <p>${dailyChallengeText}</p>
      <p>${weeklyChallengeText}</p>
      ${leaderboardHTML}
      <p>Follow <a href="https://x.com/DexHuntGame" target="_blank">@DexHuntGame</a> for updates!</p>
      <div class="share-buttons">
        <button class="share-btn" onclick="dailyLoginReward()">Claim Daily Login</button>
        <button class="share-btn" onclick="exportReactionData()">Export Reaction Data</button>
        <button class="share-btn" onclick="shareAchievement()">Share on X</button>
        ${playerLevel.level >= 3 ? '<button class="share-btn" onclick="startJackpotDuel()">Jackpot Duel (0.01 SOL)</button>' : ''}
        <button class="share-btn" onclick="alert('Multi-Target Mode coming in Version 2.0! Follow @DexHuntGame on X!')" disabled>Multi-Target Mode (Soon!)</button>
      </div>
      <button onclick="toggleLinksLeaderboard()">Close</button>
    `;
  }

  function claimDailyReward() {
    if (dailyChallenge.winsToday >= 3 && !dailyChallenge.rewardClaimed && dailyChallenge.lastReset === new Date().toDateString()) {
      totalDhuntEarned += 50;
      dailyChallenge.rewardClaimed = true;
      localStorage.setItem('totalDhuntEarned', totalDhuntEarned);
      localStorage.setItem('dailyChallenge', JSON.stringify(dailyChallenge));
      document.getElementById('log').textContent = 'Claimed 50 $DHUNT for daily challenge!';
      updateLeaderboard();
    }
  }

  function claimWeeklyReward() {
    if (weeklyChallenge.duelsPlayed >= 10 && !weeklyChallenge.rewardClaimed && weeklyChallenge.weekStart === getWeekNumber()) {
      totalDhuntEarned += 100;
      weeklyChallenge.rewardClaimed = true;
      localStorage.setItem('totalDhuntEarned', totalDhuntEarned);
      localStorage.setItem('weeklyChallenge', JSON.stringify(weeklyChallenge));
      document.getElementById('log').textContent = 'Claimed 100 $DHUNT for weekly challenge!';
      updateLeaderboard();
    }
  }

  function startJackpotDuel() {
    if (playerLevel.level < 3) {
      document.getElementById('log').textContent = 'Reach Level 3 to unlock Jackpot Duel!';
      return;
    }
    betAmount = 0.01;
    document.getElementById('log').textContent = 'Jackpot Duel! Betting 0.01 SOL for a 10x payout!';
    startDuel();
  }

  function toggleLinksLeaderboard() {
    const popup = document.getElementById('leaderboardPopup');
    if (popup.style.display === 'block') {
      popup.style.display = 'none';
    } else {
      updateLeaderboard();
      popup.style.display = 'block';
    }
  }

  function shareAchievement() {
    const gameLink = 'https://fifthgenhub.github.io/DexHunt.github.io/DexHunt2.html?ref=' + Math.random().toString(36).substr(2, 9);
    const tweetText = encodeURIComponent(`Iâ€™m Level ${playerLevel.level} in DexHunt! ðŸ¤  Fastest draw: ${bestDraw || '--'}ms, ${totalDhuntEarned} $DHUNT earned. Can you beat me? ${gameLink} @DexHuntGame #DexHunt`);
    const tweetUrl = `https://x.com/intent/tweet?text=${tweetText}`;
    navigator.clipboard.writeText(gameLink).then(() => {
      window.open(tweetUrl, '_blank');
      totalDhuntEarned += 10;
      localStorage.setItem('totalDhuntEarned', totalDhuntEarned);
      document.getElementById('log').textContent = 'Shared on X! Earned 10 $DHUNT!';
    }).catch(() => {
      document.getElementById('log').textContent = 'Failed to copy link. Share manually: ' + gameLink;
    });
  }

  const canvas = document.getElementById('gameCanvas');
  const ctx = canvas.getContext('2d');
  const duelArea = document.getElementById('duel-area');
  let eagleTargetX = 0, eagleTargetY = 100, eagleX = 0, eagleY = 0, eagleSpeedX = 0.6, eagleSpeedY = 0.1;
  let cryptoX = 500, cryptoY = 50, cryptoScale = 1, cryptoPulse = 0.05;

  function resizeCanvas() {
    canvas.width = duelArea.offsetWidth;
    canvas.height = duelArea.offsetHeight;
    eagleTargetX = canvas.width * 0.5 + 20;
    eagleTargetY = 50;
    eagleX = eagleTargetX;
    eagleY = eagleTargetY - 50;
    cryptoX = canvas.width * 0.5 - 50;
  }
  resizeCanvas();
  window.addEventListener('resize', resizeCanvas);

  const background = new Image();
  background.src = 'assets/DexHuntBackground_v2.png';
  const cloud1 = new Image();
  cloud1.src = 'assets/cloud1.png';
  const cloud2 = new Image();
  cloud2.src = 'assets/cloud2.png';
  const cloud3 = new Image();
  cloud3.src = 'assets/cloud3.png';
  const tumbleweed1 = new Image();
  tumbleweed1.src = 'assets/tumbleweed1.png';
  const tumbleweed2 = new Image();
  tumbleweed2.src = 'assets/tumbleweed2.png';
  const tumbleweed3 = new Image();
  tumbleweed3.src = 'assets/tumbleweed3.png';
  const bird1 = new Image();
  bird1.src = 'assets/bird1.png';
  const bird2 = new Image();
  bird2.src = 'assets/bird2.png';
  const crypto = new Image();
  crypto.src = 'assets/crypto.png';
  const eagle = new Image();
  eagle.src = 'assets/eagle.png';

  let cloud1X = 0, cloud1Speed = 0.5;
  let cloud2X = 200, cloud2Speed = 0.3;
  let cloud3X = 400, cloud3Speed = 0.4;
  let tumbleweed1X = 0, tumbleweed1Speed = 1;
  let tumbleweed2X = 100, tumbleweed2Speed = 0.8;
  let tumbleweed3X = 300, tumbleweed3Speed = 1.2;
  let bird1X = 50, bird1Y = 50, bird1SpeedX = 0.7, bird1SpeedY = 0.2;
  let bird2X = 150, bird2Y = 80, bird2SpeedX = 0.5, bird2SpeedY = -0.1;

  function animate() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    if (background.complete && background.naturalWidth !== 0) {
      ctx.drawImage(background, 0, 0, canvas.width, canvas.height);
    } else {
      ctx.fillStyle = '#4a2c00';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
    }
    if (cloud1.complete) ctx.drawImage(cloud1, cloud1X, 50, cloud1.width, cloud1.height);
    if (cloud2.complete) ctx.drawImage(cloud2, cloud2X, 80, cloud2.width, cloud2.height);
    if (cloud3.complete) ctx.drawImage(cloud3, cloud3X, 60, cloud3.width, cloud3.height);
    cloud1X += cloud1Speed;
    cloud2X += cloud2Speed;
    cloud3X += cloud3Speed;
    if (cloud1X > canvas.width) cloud1X = -cloud1.width;
    if (cloud2X > canvas.width) cloud2X = -cloud2.width;
    if (cloud3X > canvas.width) cloud3X = -cloud3.width;

    if (tumbleweed1.complete) ctx.drawImage(tumbleweed1, tumbleweed1X, canvas.height - 80, tumbleweed1.width, tumbleweed1.height);
    if (tumbleweed2.complete) ctx.drawImage(tumbleweed2, tumbleweed2X, canvas.height - 60, tumbleweed2.width, tumbleweed2.height);
    if (tumbleweed3.complete) ctx.drawImage(tumbleweed3, tumbleweed3X, canvas.height - 100, tumbleweed3.width, tumbleweed3.height);
    tumbleweed1X += tumbleweed1Speed;
    tumbleweed2X += tumbleweed2Speed;
    tumbleweed3X += tumbleweed3Speed;
    if (tumbleweed1X > canvas.width) {
      tumbleweed1X = -tumbleweed1.width;
      if (Math.random() < 0.3) audioElements[10].play();
    }
    if (tumbleweed2X > canvas.width) tumbleweed2X = -tumbleweed2.width;
    if (tumbleweed3X > canvas.width) tumbleweed3X = -tumbleweed3.width;

    if (bird1.complete) ctx.drawImage(bird1, bird1X, bird1Y, bird1.width, bird1.height);
    if (bird2.complete) ctx.drawImage(bird2, bird2X, bird2Y, bird2.width, bird2.height);
    bird1X += bird1SpeedX;
    bird1Y += bird1SpeedY;
    bird2X += bird2SpeedX;
    bird2Y += bird2SpeedY;
    if (bird1X > canvas.width || bird1X < 0) bird1SpeedX *= -1;
    if (bird1Y > 150 || bird1Y < 0) bird1SpeedY *= -1;
    if (bird2X > canvas.width || bird2X < 0) bird2SpeedX *= -1;
    if (bird2Y > 150 || bird2Y < 0) bird2SpeedY *= -1;

    if (crypto.complete) {
      ctx.save();
      ctx.translate(cryptoX + crypto.width / 2, cryptoY + crypto.height / 2);
      ctx.scale(cryptoScale, cryptoScale);
      ctx.drawImage(crypto, -crypto.width / 2, -crypto.height / 2, crypto.width, crypto.height);
      ctx.restore();
    }
    cryptoScale += cryptoPulse;
    if (cryptoScale > 1.2 || cryptoScale < 1) cryptoPulse *= -1;

    if (eagle.complete) {
      ctx.drawImage(eagle, eagleX, eagleY, 80, 80);
      eagleX += eagleSpeedX;
      eagleY += eagleSpeedY;
      if (eagleX > canvas.width - 80 || eagleX < 0) eagleSpeedX *= -1;
      if (eagleY > 150 || eagleY < 0) eagleSpeedY *= -1;
    }

    if (canShoot && bangShownAt) {
      const elapsed = performance.now() - bangShownAt;
      const chambers = Math.min(Math.floor((elapsed / 750) * 6), 6);
      const color = elapsed < 500 ? 'green' : elapsed < 600 ? 'yellow' : 'red';
      ctx.save();
      ctx.translate(canvas.width - 50, 30);
      ctx.beginPath();
      ctx.arc(0, 0, 20, 0, Math.PI * 2);
      ctx.fillStyle = '#8b5a2b';
      ctx.fill();
      for (let i = 0; i < 6; i++) {
        ctx.save();
        ctx.rotate((Math.PI / 3) * i);
        ctx.beginPath();
        ctx.arc(0, -12, 4, 0, Math.PI * 2);
        ctx.fillStyle = i < chambers ? color : '#333';
        ctx.fill();
        ctx.restore();
      }
      ctx.restore();
    }

    requestAnimationFrame(animate);
  }

  const assetsToLoad = [
    { resource: background, name: 'Background' },
    { resource: cloud1, name: 'Cloud1' },
    { resource: cloud2, name: 'Cloud2' },
    { resource: cloud3, name: 'Cloud3' },
    { resource: tumbleweed1, name: 'Tumbleweed1' },
    { resource: tumbleweed2, name: 'Tumbleweed2' },
    { resource: tumbleweed3, name: 'Tumbleweed3' },
    { resource: bird1, name: 'Bird1' },
    { resource: bird2, name: 'Bird2' },
    { resource: crypto, name: 'Crypto' },
    { resource: eagle, name: 'Eagle' }
  ];

  Promise.all(
    assetsToLoad.map(({ resource, name }) => new Promise((resolve, reject) => {
      resource.onload = () => {
        console.log(`${name} loaded successfully`);
        resolve();
      };
      resource.onerror = () => {
        console.error(`Failed to load ${name} at ${resource.src}`);
        document.getElementById('loadingScreen').innerHTML += `<p>Failed to load ${name}. Please check your connection.</p>`;
        resolve();
      };
    }))
  ).then(() => {
    Promise.all(
      audioElements.map(audio => new Promise((resolve) => {
        if (audio.readyState >= 2) {
          console.log(`${audio.id} audio ready`);
          resolve();
        } else {
          audio.oncanplaythrough = () => {
            console.log(`${audio.id} audio loaded`);
            resolve();
          };
          audio.onerror = () => {
            console.error(`Failed to load audio ${audio.id} at ${audio.src}`);
            document.getElementById('loadingScreen').innerHTML += `<p>Failed to load audio ${audio.id}. Please check your connection.</p>`;
            resolve();
          };
        }
      }))
    ).then(() => {
      document.getElementById('loadingScreen').style.display = 'none';
      animate();
      showTutorial();
    }).catch(err => {
      console.error("Audio loading error:", err);
      document.getElementById('loadingScreen').innerHTML = 'Error loading audio files. Please try again. <button onclick="location.reload()">Reload</button>';
    });
  }).catch(err => {
    console.error("Image loading error:", err);
    document.getElementById('loadingScreen').innerHTML = 'Error loading game assets. Please try again. <button onclick="location.reload()">Reload</button>';
  });

  const bangElement = document.getElementById('bang');
  if (bangElement) {
    bangElement.addEventListener('click', shoot);
  } else {
    console.error("Bang element not found in DOM!");
  }

  if (duelArea) {
    duelArea.addEventListener('click', (event) => {
      console.log("Duel area clicked at:", event.clientX, event.clientY);
      event.stopPropagation();
    });
  } else {
    console.error("Duel area not found in DOM!");
  }

  window.addEventListener('load', () => {
    const connectButton = document.querySelector('.wallet-btn');
    if (connectButton) {
      connectButton.addEventListener('click', connectWallet);
    }
  });
</script>
</body>
</html>